
# SQL to alter database schema to incorporate data_files table
# NOTES:
# 	1 - First made python changes to SQLAlchemy schema definitions in modules.DB_classes.py
# 	2 - Then make a connection to the original database from Python. This will trigger SQLAlchemy to create the table 'data_files' as defined in DB_classes

# insure correct database
USE chd_test;

# Copy info from euv_images to the new data_files table
INSERT INTO data_files (data_id, date_obs, fname_raw, fname_hdf, flag)
SELECT image_id, date_obs, fname_raw, fname_hdf, flag FROM euv_images;

# Add foreign key to EUV_Images
ALTER TABLE euv_images ADD CONSTRAINT fk_data_id FOREIGN KEY (data_id) REFERENCES data_files(data_id);

# Insert provider and type into data_files for euv_images?
UPDATE data_files 
SET provider='LMSAL-EUVI_A' , type='EUV_Image' 
WHERE data_id IN (SELECT image_id FROM euv_images WHERE instrument='EUVI-A');

UPDATE data_files 
SET provider='LMSAL-EUVI_B' , type='EUV_Image' 
WHERE data_id IN (SELECT image_id FROM euv_images WHERE instrument='EUVI-B');

UPDATE data_files 
SET provider='LMSAL-AIA' , type='EUV_Image' 
WHERE data_id IN (SELECT image_id FROM euv_images WHERE instrument='AIA');

# Remove duplicated columns from euv_images. These columns now reside in data_files
ALTER TABLE euv_images DROP COLUMN fname_raw, DROP COLUMN fname_hdf;


# Change image_combo_assoc to data_combo_assoc
ALTER TABLE image_combo_assoc RENAME TO data_combo_assoc;
ALTER TABLE image_combos RENAME TO data_combos;
# Shift foreign key to data_files table
ALTER TABLE data_combo_assoc DROP FOREIGN KEY data_combo_assoc_ibfk_2
ALTER TABLE data_combo_assoc ADD CONSTRAINT data_combo_assoc_ibfk_2 FOREIGN KEY (data_id) REFERENCES data_files(data_id);


# Change existing column names
ALTER TABLE data_combo_assoc RENAME COLUMN image_id TO data_id;
ALTER TABLE euv_images RENAME COLUMN image_id TO data_id;




# --- Bring Schema up-to-date with modules.db_classes.py definitions -----
# Update EUV_Images index
ALTER TABLE euv_images DROP INDEX test_index, ADD UNIQUE INDEX test_index (
date_obs, flag, instrument, wavelength);
# Add search index for Carrington-rotation queries
ALTER TABLE euv_images ADD INDEX rot_search (cr_rot, flag, instrument, wavelength);
# Set flag default to 0
ALTER TABLE euv_images ALTER COLUMN flag SET DEFAULT 0;




















